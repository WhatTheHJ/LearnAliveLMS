package com.lms.attendance.service;

import java.util.List;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import com.lms.attendance.model.TeamActivityPost;
import com.lms.attendance.model.TeamActivityApplication;
import com.lms.attendance.model.TeamActivityComment;
import com.lms.attendance.repository.TeamActivityPostMapper;
import com.lms.attendance.repository.TeamActivityApplicationMapper;
import com.lms.attendance.repository.TeamActivityCommentMapper;

@Service
public class TeamActivityService {
    private final TeamActivityPostMapper postMapper;
    private final TeamActivityApplicationMapper applicationMapper;
    private final TeamActivityCommentMapper commentMapper;

    public TeamActivityService(TeamActivityPostMapper postMapper,
                               TeamActivityApplicationMapper applicationMapper,
                               TeamActivityCommentMapper commentMapper) {
        this.postMapper = postMapper;
        this.applicationMapper = applicationMapper;
        this.commentMapper = commentMapper;
    }

    // 팀 활동 게시글 생성
    @Transactional
    public TeamActivityPost createTeamActivityPost(TeamActivityPost post) {
        if (post.getLikes() == null) {
            post.setLikes(0);
        }
        postMapper.createPost(post);
        return post;
    }

    // 모든 팀 활동 게시글 조회
    public List<TeamActivityPost> getAllTeamActivityPosts() {
        return postMapper.getAllPosts();
    }

    // 특정 팀 활동 게시글 조회
    public TeamActivityPost getTeamActivityPostById(int postId) {
        return postMapper.getPostById(postId);
    }

    // 참가 신청 생성 (학생이 신청)
    @Transactional
    public TeamActivityApplication applyForTeamActivity(TeamActivityApplication application) {
        application.setStatus("PENDING");
        applicationMapper.applyForTeamActivity(application);
        return application;
    }

    // 신청 상태 업데이트 (승인/거절)
    public void updateApplicationStatus(int applicationId, String status) {
        applicationMapper.updateApplicationStatus(applicationId, status);
    }

    // 특정 게시글에 대한 참가 신청 목록 조회
    public List<TeamActivityApplication> getApplicationsByPostId(int postId) {
        return applicationMapper.getApplicationsByPostId(postId);
    }

    public TeamActivityApplication getApplicationById(int applicationId) {
        return applicationMapper.getApplicationById(applicationId);
    }

    // 댓글 추가
    @Transactional
    public TeamActivityComment addComment(TeamActivityComment comment) {
        commentMapper.addComment(comment);
        return comment;
    }

    // 특정 게시글의 댓글 목록 조회
    public List<TeamActivityComment> getCommentsByPostId(int postId) {
        return commentMapper.getCommentsByPostId(postId);
    }
}
