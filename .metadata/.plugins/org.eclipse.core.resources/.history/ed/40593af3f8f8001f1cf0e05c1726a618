package com.korea.attendance.service;

import java.util.List;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.korea.attendance.model.Survey;
import com.korea.attendance.model.SurveyBoard;
import com.korea.attendance.model.SurveyQuestion;
import com.korea.attendance.model.SurveyResponse;
import com.korea.attendance.repository.SurveyMapper;

@Service
public class SurveyService {
    private final SurveyMapper surveyMapper;
    private final ObjectMapper objectMapper = new ObjectMapper(); // âœ… JSON ë³€í™˜ìš© ê°ì²´

    public SurveyService(SurveyMapper surveyMapper) {
        this.surveyMapper = surveyMapper;
    }

    /** âœ… íŠ¹ì • ê°•ì˜ì‹¤ì˜ ì„¤ë¬¸ì¡°ì‚¬ ê²Œì‹œíŒ ëª©ë¡ ì¡°íšŒ */
    public List<SurveyBoard> getSurveyBoardsByClassId(int classId) {
        List<SurveyBoard> boards = surveyMapper.findSurveyBoardsByClassId(classId);

        // âœ… ë§Œì•½ boardsê°€ ë¹„ì–´ìˆë‹¤ë©´ ìƒˆë¡œìš´ ê²Œì‹œíŒ ìë™ ìƒì„± í›„ ì¡°íšŒ
        if (boards.isEmpty()) {
            surveyMapper.createSurveyBoard(classId);
            boards = surveyMapper.findSurveyBoardsByClassId(classId);
        }

        return boards;
    }
    
    /** âœ… ì„¤ë¬¸ì¡°ì‚¬ ê²Œì‹œíŒ ìƒì„± */
    public SurveyBoard createSurveyBoard(int classId) {
        surveyMapper.createSurveyBoard(classId);
        return surveyMapper.getSurveyBoardByClassId(classId);
    }

    /** âœ… íŠ¹ì • ê°•ì˜ì‹¤ì˜ ë‹¨ì¼ ì„¤ë¬¸ì¡°ì‚¬ ê²Œì‹œíŒ ì¡°íšŒ */
    public SurveyBoard getSurveyBoardByClassId(int classId) {
        return surveyMapper.getSurveyBoardByClassId(classId);
    }

    /** âœ… íŠ¹ì • ê²Œì‹œíŒì˜ ì„¤ë¬¸ì¡°ì‚¬ ëª©ë¡ ì¡°íšŒ */
    public List<Survey> getSurveysByBoard(int boardId) {
        return surveyMapper.getSurveysByBoard(boardId);
    }

    /** âœ… ì„¤ë¬¸ì¡°ì‚¬ + ì§ˆë¬¸ì„ í•œ ë²ˆì— ì €ì¥ (íŠ¸ëœì­ì…˜ ì ìš©) */

    @Transactional
    public Survey createSurveyWithQuestions(Survey survey) {
        surveyMapper.insertSurvey(survey);
        ObjectMapper objectMapper = new ObjectMapper(); // âœ… Jackson ì‚¬ìš©

        for (SurveyQuestion question : survey.getQuestions()) {
            question.setSurveyId(survey.getSurveyId());

            if ("radio".equals(question.getQuestionType()) || "checkbox".equals(question.getQuestionType())) {
                try {
                    // âœ… ê°ê´€ì‹ ë¬¸ì œì˜ ê²½ìš° optionsì„ JSON ë°°ì—´ í˜•íƒœë¡œ ë³€í™˜
                    String jsonOptions = objectMapper.writeValueAsString(question.getOptions());

                    surveyMapper.insertSurveyQuestion(
                        question.getSurveyId(),
                        question.getQuestionText(),
                        question.getQuestionType(),
                        jsonOptions,  // JSON ë°°ì—´ë¡œ ë³€í™˜ëœ ì„ íƒì§€ ê°’
                        "checkbox".equals(question.getQuestionType()) ? question.getMinSelect() : null,
                        "checkbox".equals(question.getQuestionType()) ? question.getMaxSelect() : null,
                        null,  // âœ… ê°ê´€ì‹ì—ëŠ” minValue ì‚¬ìš© ì•ˆ í•¨
                        null,  // âœ… ê°ê´€ì‹ì—ëŠ” maxValue ì‚¬ìš© ì•ˆ í•¨
                        null,  // âœ… ê°ê´€ì‹ì—ëŠ” minLabel ì‚¬ìš© ì•ˆ í•¨
                        null   // âœ… ê°ê´€ì‹ì—ëŠ” maxLabel ì‚¬ìš© ì•ˆ í•¨
                    );
                } catch (Exception e) {
                    throw new RuntimeException("ê°ê´€ì‹ ì§ˆë¬¸ ì˜µì…˜ì„ JSONìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
                }
            } 
            else if ("linear_scale".equals(question.getQuestionType())) {
                // âœ… ì„ í˜• ë°°ìœ¨ì¼ ê²½ìš° min/max ê°’ê³¼ ë¼ë²¨ì„ ì €ì¥
                surveyMapper.insertSurveyQuestion(
                    question.getSurveyId(),
                    question.getQuestionText(),
                    question.getQuestionType(),
                    null,  // âœ… ì„ í˜• ë°°ìœ¨ì€ options ì—†ìŒ
                    null,  // âœ… ì„ í˜• ë°°ìœ¨ì€ minSelect ì—†ìŒ
                    null,  // âœ… ì„ í˜• ë°°ìœ¨ì€ maxSelect ì—†ìŒ
                    question.getMinValue(),  // âœ… ìµœì†Œê°’ ì €ì¥
                    question.getMaxValue(),  // âœ… ìµœëŒ€ê°’ ì €ì¥
                    question.getMinLabel(),  // âœ… ìµœì†Œ ë¼ë²¨ ì €ì¥
                    question.getMaxLabel()   // âœ… ìµœëŒ€ ë¼ë²¨ ì €ì¥
                );
            } 
            else {
                // âœ… ì„œìˆ í˜• ë¬¸ì œì˜ ê²½ìš° options/min/max ì—†ì´ ì €ì¥
                surveyMapper.insertSurveyQuestion(
                    question.getSurveyId(),
                    question.getQuestionText(),
                    question.getQuestionType(),
                    null,  // âœ… ì„œìˆ í˜• ë¬¸ì œì´ë¯€ë¡œ options ì—†ìŒ
                    null,  // âœ… ì„œìˆ í˜• ë¬¸ì œì´ë¯€ë¡œ minSelect ì—†ìŒ
                    null,  // âœ… ì„œìˆ í˜• ë¬¸ì œì´ë¯€ë¡œ maxSelect ì—†ìŒ
                    null,  // âœ… ì„œìˆ í˜• ë¬¸ì œì´ë¯€ë¡œ minValue ì—†ìŒ
                    null,  // âœ… ì„œìˆ í˜• ë¬¸ì œì´ë¯€ë¡œ maxValue ì—†ìŒ
                    null,  // âœ… ì„œìˆ í˜• ë¬¸ì œì´ë¯€ë¡œ minLabel ì—†ìŒ
                    null   // âœ… ì„œìˆ í˜• ë¬¸ì œì´ë¯€ë¡œ maxLabel ì—†ìŒ
                );
            }
        }
        return survey;
    }


    /** âœ… íŠ¹ì • ì„¤ë¬¸ì¡°ì‚¬ì˜ ì§ˆë¬¸ ëª©ë¡ ì¡°íšŒ */
    public List<SurveyQuestion> getSurveyQuestions(int surveyId) {
        return surveyMapper.getSurveyQuestions(surveyId);
    }

    /** âœ… íŠ¹ì • ì„¤ë¬¸ì¡°ì‚¬ì˜ ì‘ë‹µ ëª©ë¡ ì¡°íšŒ */
    public List<SurveyResponse> getSurveyResponses(int surveyId) {
        return surveyMapper.getSurveyResponses(surveyId);
    }

    /** âœ… íŠ¹ì • í•™ìƒì´ íŠ¹ì • ì„¤ë¬¸ì¡°ì‚¬ì— ëŒ€í•œ ì‘ë‹µ ì¡°íšŒ */
    public List<SurveyResponse> getStudentSurveyResponses(int surveyId, String studentId) {
        return surveyMapper.getStudentSurveyResponses(surveyId, studentId);
    }

    /** âœ… íŠ¹ì • í•™ìƒì´ ì‘ë‹µí•œ ëª¨ë“  ì„¤ë¬¸ì¡°ì‚¬ ëª©ë¡ ì¡°íšŒ */
    public List<Survey> getStudentSurveys(String studentId) {
        return surveyMapper.getStudentSurveys(studentId);
    }

    /** âœ… ì„¤ë¬¸ ì‘ë‹µ ì œì¶œ (íŠ¸ëœì­ì…˜ ì ìš©) */
    @Transactional // ğŸš€ íŠ¸ëœì­ì…˜ í™œì„±í™”
    public void submitSurveyResponse(SurveyResponse response) {
        surveyMapper.insertSurveyResponse(response.getQuestionId(), response.getStudentId(), response.getResponseValue());
    }
}
