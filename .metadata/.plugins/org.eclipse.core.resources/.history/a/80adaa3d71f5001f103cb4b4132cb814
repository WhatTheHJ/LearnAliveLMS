package com.korea.attendance.controller;

import com.korea.attendance.model.*;
import com.korea.attendance.service.SurveyService;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/surveys") // âœ… API ê¸°ë³¸ ê²½ë¡œ
public class SurveyController {

    private final SurveyService surveyService;

    public SurveyController(SurveyService surveyService) {
        this.surveyService = surveyService;
    }

    /** âœ… íŠ¹ì • ê°•ì˜ì‹¤ì˜ ëª¨ë“  ì„¤ë¬¸ì¡°ì‚¬ ê²Œì‹œíŒ ì¡°íšŒ */
    @GetMapping("/boards/{classId}")
    public ResponseEntity<List<SurveyBoard>> getSurveyBoards(@PathVariable("classId") int classId) {
        return ResponseEntity.ok(surveyService.getSurveyBoardsByClassId(classId));
    }
    
    /** âœ… ì„¤ë¬¸ì¡°ì‚¬ ê²Œì‹œíŒ ìƒì„± (ìƒì„± í›„ ë°˜í™˜ ë³´ì¥) */
    @PostMapping("/board/{classId}")
    public ResponseEntity<SurveyBoard> createSurveyBoard(@PathVariable("classId") int classId) {
        surveyService.createSurveyBoard(classId);
        
        // âœ… ê²Œì‹œíŒì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ ë‹¤ì‹œ ì¡°íšŒí•˜ì—¬ ë°˜í™˜
        SurveyBoard createdBoard = surveyService.getSurveyBoardByClassId(classId);
        if (createdBoard == null) {
            return ResponseEntity.badRequest().build(); // ìƒì„± ì‹¤íŒ¨ ì‹œ 400 ë°˜í™˜
        }

        return ResponseEntity.ok(createdBoard);
    }

    /** âœ… ì„¤ë¬¸ì¡°ì‚¬ ìƒì„± */
    @PostMapping("/post/{classId}") // ğŸ”¥ classId ì¶”ê°€í•˜ì—¬ Board í™•ì¸ í›„ Post ìƒì„±
    public ResponseEntity<Integer> createSurvey(@PathVariable("classId") int classId, @RequestBody SurveyPost surveyPost) {
        // âœ… ì„¤ë¬¸ì¡°ì‚¬ ê²Œì‹œíŒì„ ë¨¼ì € ê°€ì ¸ì˜¤ê±°ë‚˜ ìƒì„±
        SurveyBoard board = surveyService.getOrCreateSurveyBoard(classId);
        surveyPost.setBoardId(board.getBoardId()); // ğŸ”¥ boardIdë¥¼ ëª…í™•í•˜ê²Œ ì„¤ì •
        
        // âœ… ì„¤ë¬¸ì¡°ì‚¬ ìƒì„±
        surveyService.createSurveyPost(surveyPost);

        // âœ… ìƒì„±ëœ surveyId ë°˜í™˜
        return ResponseEntity.ok(surveyPost.getSurveyId());
    }

    /** âœ… íŠ¹ì • ê²Œì‹œíŒì˜ ì„¤ë¬¸ì¡°ì‚¬ ëª©ë¡ ì¡°íšŒ */
    @GetMapping("/post/{boardId}")
    public ResponseEntity<List<SurveyPost>> getSurveyPosts(@PathVariable("boardId") int boardId) {
        return ResponseEntity.ok(surveyService.getSurveyPostsByBoardId(boardId));
    }

    /** âœ… ì„¤ë¬¸ ì§ˆë¬¸ ì¶”ê°€ */
    @PostMapping("/question")
    public ResponseEntity<String> createSurveyQuestion(@RequestBody SurveyQuestion question) {
        surveyService.createSurveyQuestion(question);
        return ResponseEntity.ok("ì§ˆë¬¸ ì¶”ê°€ ì™„ë£Œ");
    }

    /** âœ… íŠ¹ì • ì„¤ë¬¸ì¡°ì‚¬ì˜ ì§ˆë¬¸ ëª©ë¡ ì¡°íšŒ */
    @GetMapping("/question/{surveyId}")
    public ResponseEntity<List<SurveyQuestion>> getSurveyQuestions(@PathVariable("surveyId") int surveyId) {
        return ResponseEntity.ok(surveyService.getSurveyQuestionsBySurveyId(surveyId));
    }

    /** âœ… ì„¤ë¬¸ ì‘ë‹µ ì €ì¥ */
    @PostMapping("/response")
    public ResponseEntity<String> submitSurveyResponse(@RequestBody SurveyResponse response) {
        surveyService.saveSurveyResponse(response);
        return ResponseEntity.ok("ì‘ë‹µ ì €ì¥ ì™„ë£Œ");
    }

    /** âœ… íŠ¹ì • ì„¤ë¬¸ì¡°ì‚¬ì˜ ì‘ë‹µ ëª©ë¡ ì¡°íšŒ */
    @GetMapping("/response/{surveyId}")
    public ResponseEntity<List<SurveyResponse>> getSurveyResponses(@PathVariable("surveyId") int surveyId) {
        return ResponseEntity.ok(surveyService.getSurveyResponsesBySurveyId(surveyId));
    }
}
