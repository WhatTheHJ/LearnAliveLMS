package com.lms.attendance.controller;

import java.util.List;
import java.util.Map;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.lms.attendance.model.LoginRequest;
import com.lms.attendance.model.Student;
import com.lms.attendance.repository.AuthMapper;
import com.lms.attendance.service.AuthService;
import com.lms.attendance.service.StudentService;

@CrossOrigin(origins = "http://localhost:5173", allowCredentials = "true")
@RestController
@RequestMapping("/api/auth")
public class AuthController {

    private final AuthService authService;
    private final StudentService studentService;
    private final AuthMapper authMapper;
    
    public AuthController(AuthService authService, StudentService studentService, AuthMapper authMapper) {
        this.authService = authService;
        this.studentService = studentService;
        this.authMapper = authMapper;
    
    }

 // âœ… í•™ìŠµì(í•™ìƒ) íšŒì›ê°€ì…
    @PostMapping("/register/student")
    public ResponseEntity<?> registerStudent(@RequestBody Student student) {
    	System.out.println("íšŒì›ê°€ì… ìš”ì²­ ë°›ì€ í•™ìƒ ì •ë³´: " + student);
        try {
            studentService.registerStudent(student);
            return ResponseEntity.ok(Map.of("success", true, "message", "í•™ìƒ íšŒì›ê°€ì… ì„±ê³µ!"));
        } catch (Exception e) {
            return ResponseEntity.badRequest().body(Map.of("success", false, "message", "í•™ìƒ íšŒì›ê°€ì… ì‹¤íŒ¨!"));
        }
    }

  //í•™ìŠµì í•™ë²ˆ ì¤‘ë³µí™•ì¸
    @PostMapping("/checkStudentId")
    public ResponseEntity<?> checkStudentId(@RequestBody Map<String, String> request) {
        String studentId = request.get("studentId");
        if (studentId == null || studentId.trim().isEmpty()) {
            return ResponseEntity.badRequest().body(Map.of("success", false, "message", "í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”."));
        }
        // StudentServiceì˜ findStudentById ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ í™•ì¸
        Student existingStudent = studentService.findStudentById(studentId);
        boolean available = (existingStudent == null);
        return ResponseEntity.ok(Map.of("available", available));
    }
    
    
    
    // âœ… í†µí•© ë¡œê·¸ì¸ (í•™ìƒ, êµìˆ˜, ê´€ë¦¬ì)
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request) {
        System.out.println("ë¡œê·¸ì¸ ì‹œë„ userId: " + request.getUserId());
        String userId = request.getUserId();
        String password = request.getPassword();

        // âœ… ê´€ë¦¬ì ë¡œê·¸ì¸ ì²˜ë¦¬
        if ("admin".equalsIgnoreCase(userId)) {
            String adminPassword = authService.getAdminPasswordById(userId);
            if (adminPassword == null || !authService.isPasswordValid(password, adminPassword)) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                        .body(Map.of("success", false, "message", "ì˜ëª»ëœ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤."));
            }

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "message", "ë¡œê·¸ì¸ ì„±ê³µ",
                    "role", "ADMIN",
                    "username", "ê´€ë¦¬ì",
                    "userId", userId,
                    "classIds", List.of()  // ê´€ë¦¬ìì—ê² classId ì—†ìŒ
            ));
        }

        // âœ… ì¼ë°˜ ì‚¬ìš©ì ë¡œê·¸ì¸
        String role = authService.authenticate(userId, password);
        if (role == null) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
                    .body(Map.of("success", false, "message", "ì˜ëª»ëœ ID ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤."));
        }

        String name = authService.getUserNameByIdAndRole(userId, role);

        List<Integer> classIds = authMapper.findClassIdByUserId(userId);  // âœ… í•™ìƒ/êµìˆ˜ ëª¨ë‘ í¬í•¨
        System.out.println("ğŸ“˜ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ê°•ì˜ì‹¤ ëª©ë¡: " + classIds);
        // ì‚¬ìš©ì ì´ë¦„ ì¡°íšŒ (ê´€ë¦¬ìëŠ” ì´ë¦„ ì—†ìŒ)
        String name = "ADMIN".equalsIgnoreCase(role) ? null : authService.getUserNameByIdAndRole(request.getUserId(), role);

        // ì—­í•  í•œê¸€ ë³€í™˜
        String roleInKorean = switch (role.toLowerCase()) {
            case "ADMIN" -> "ê´€ë¦¬ì";
            case "PROFESSOR" -> "êµìˆ˜ì";
            case "STUDENT" -> "í•™ìƒ";
            default -> "ì•Œ ìˆ˜ ì—†ìŒ";
        };

        // ë¡œê·¸ì¸ ì„±ê³µ ì‘ë‹µ
        return ResponseEntity.ok(Map.of(
                "success", true,
                "message", "ë¡œê·¸ì¸ ì„±ê³µ",
                "role", role,
                "username", name,
                "classId", classId  ,
                "userId", request.getUserId()     // userId ì¶”ê°€
        ));
    }
}